/*
 * alpha.C
 *
 * FUNCTION:
 * display the alpha(z) function from the reiman-pochhammer  paper.
 *
 * HISTORY:
 * quick hack -- Linas Vepstas October 1989
 * modernize -- Linas Vepstas March 1996
 * more stuff -- January 2000
 * more stuff -- October 2004
 */

#include <math.h>
#include <stdio.h>
#include <stdlib.h>
#include <gsl/gsl_sf_gamma.h>
#include <gsl/gsl_sf_log.h>

#include "brat.h"

static double r[1002];

static void init_r (void)
{
	// #
	// # zeta expansion terms 
	// #
	// # computed with variable precision of 200 decimal places
	// # computed with 1194 bits of default mpf 
#if 1
	r[0] = -0.421583245720288081139509042383975061091691949728637259471349e1;
	r[1] = -0.135928039314847840327900826812632647287211034301506037002185e1;
	r[2] = 0.373663967902614436279557481384222010687345298462061074587454e0;
	r[3] = 0.11208619810043162885590195861821765229118855930831200474978e1;
	r[4] = 0.109602354419069540236829664011919766839074755287016332007599e1;
	r[5] = 0.611857899852474059034803596107931138354241977227217775636007e0;
	r[6] = -0.190680219559665664769755712588669773328130966028704656462302e-1;
	r[7] = -0.555358099638583082664302007331736645511797524201954948285244e0;
	r[8] = -0.857089501468883442152088206085964553049195817689560564013476e0;
	r[9] = -0.883680131428868745924810972495746957432904179222450293154288e0;
	r[10] = -0.671918834334642836551328926733208533894704920630778578471946e0;
	r[11] = -0.30574113344654934645601915714634813519319318617582372687437e0;
	r[12] = 0.113635157733630391240450658753068927910875405830690317221562e0;
	r[13] = 0.491929620062133458379779589340846428289881082339564096133493e0;
	r[14] = 0.757991726387365460937967152180529501036049480390655452335395e0;
	r[15] = 0.871742966755174233145482477024323132393416396252777958433874e0;
	r[16] = 0.825022589536688901247280222648221841118502597611372794006834e0;
	r[17] = 0.63719129815894288968784985485419378760348069668181035974567e0;
	r[18] = 0.347533770260255500118148889902524975244438334922819991260333e0;
	r[19] = 0.634233722608254838121545557203362750448396575189353090862815e-2;
	r[20] = -0.333792043674441356768472499154198113128540493035608077905226e0;
	r[21] = -0.625394214910636432385670344839022894025936504074435657577158e0;
	r[22] = -0.831577308220388664198318695958842236886301768696627018199703e0;
	r[23] = -0.929315463986400536759306600491659702704132785428169144697408e0;
	r[24] = -0.910570343304904361219625111407670312921990246759159680185961e0;
	r[25] = -0.781548505308389057197836469914066406692210536011443031490805e0;
	r[26] = -0.560504821784065618841830003828828970750176450210246255177237e0;
	r[27] = -0.274569906353225053780266655597866017093788732038231917902004e0;
	r[28] = 0.439187839528960231586854773516050349552248085733733170493176e-1;
	r[29] = 0.361146364269758751286394454737924542612327662910798730980523e0;
	r[30] = 0.645248807460432260874213544710145003994803304865007471375661e0;
	r[31] = 0.869169261012588476590191062483072580272300793215494488641658e0;
	r[32] = 0.10127675331898886990944654722798207361162241338153275466205e1;
	r[33] = 0.106410002490470751263368708494673180626764772540725535523738e1;
	r[34] = 0.101986916027992977376036110240639773299533315184926452979602e1;
	r[35] = 0.885108571790635405343236683403463474819681388144884284227901e0;
	r[36] = 0.672220743862697870346420660341227458930659112866558518664919e0;
	r[37] = 0.399517017507281880741564227121494894675629415106822500254207e0;
	r[38] = 0.894266356945272114741959634650042429736882208146857638395774e-1;
	r[39] = -0.233456343831619008515533439829505842487258066202995871520496e0;
	r[40] = -0.544329501353790630756657553206443576103086405275374219616297e0;
	r[41] = -0.82000261037906562700151811242447941491465920085114038080113e0;
	r[42] = -0.104046912339919247423696532932129256762632013693604619312517e1;
	r[43] = -0.119014534202654835946430315942885832527923543002943877951579e1;
	r[44] = -0.125872528225546900521217817646002952194950635453486750657485e1;
	r[45] = -0.124162968279163644454348440643835831781482959209200783053031e1;
	r[46] = -0.114005548303492478350703713315155299435898810283645925419269e1;
	r[47] = -0.960656115592798728335254754974529513784512241989119030689945e0;
	r[48] = -0.714902246922069667340558913409657137051973023704967679083429e0;
	r[49] = -0.418186694950500144931033588147992440939162026150002183453832e0;
	r[50] = -0.887460517912076642943865585383938551798724981197825669093498e-1;
	r[51] = 0.253524753222670299723777327216087768056228961336205680999596e0;
	r[52] = 0.588289650820653218554579856510215782008878921107852820866912e0;
	r[53] = 0.895950037230563728911262303900963993175556321773671330256774e0;
	r[54] = 0.115872264117681000889020509293665979032751952760096739240425e1;
	r[55] = 0.136156515233987545890514587606912698757696033888917243324655e1;
	r[56] = 0.149291036710807560907533550039710039952801209855417095583236e1;
	r[57] = 0.154518267025513401009146580972111045055211410573037381306876e1;
	r[58] = 0.151508380181546767254933305198497692585233056581335184947479e1;
	r[59] = 0.140364740760902295831784792667734190009575261998954143579948e1;
	r[60] = 0.121607329803095357133230127645790781584701074235771455655452e1;
	r[61] = 0.961362219396270665321760270774985476994480770686165466544326e0;
	r[62] = 0.651779973426300485461877774156862539173927420058131798223245e0;
	r[63] = 0.302185720668535121757319272307702608049255630123188601362584e0;
	r[64] = -0.707367980568641283084099890381575066269003983929651649757606e-1;
	r[65] = -0.4493045616736864130369423311601046544735746332636020072353e0;
	r[66] = -0.815676658266871893543166402457997828126518704637942485248866e0;
	r[67] = -0.115267322672392752640882808620716582535712881835723946876971e1;
	r[68] = -0.144453683138114534167437203747098852259755305402039553305367e1;
	r[69] = -0.167760580971632251005418624010876711556075765670565182812679e1;
	r[70] = -0.184087472947993452505307622015092293961687914340091353216417e1;
	r[71] = -0.192642331324678516725151522422530209007584405616790345246395e1;
	r[72] = -0.192970172897586234081074320025419369232598591328700447365562e1;
	r[73] = -0.184966671559613044131155805819743882471412261879252154517812e1;
	r[74] = -0.168876935010363490747028013757006379884135759018871777245987e1;
	r[75] = -0.145280113803228078934427668898585066457132539788588862556684e1;
	r[76] = -0.11506103321193377769139567358090507485101946258363038672732e1;
	r[77] = -0.793704806113212751248872762951031596218332173956665123602377e0;
	r[78] = -0.395761326692148794141103373698385025587827096992010074379439e0;
	r[79] = 0.27936386222965809876817353727703425499139284306799666733911e-1;
	r[80] = 0.461106863740521745525409825246200630534179675419527611568282e0;
	r[81] = 0.88710282797843855600726053934005293551110612420696832023982e0;
	r[82] = 0.128954168278544427665874791891255964041415462064313128946359e1;
	r[83] = 0.165291156222264362190205428588285154745682719866116727465953e1;
	r[84] = 0.196313188295916659445331518247499593804949171532342557547709e1;
	r[85] = 0.22080499144108458525146333872633311763828127170076659057778e1;
	r[86] = 0.237785794597402056660394804398504576658920069259823512454561e1;
	r[87] = 0.246541905673438627700385281187088171362370839891865395636251e1;
	r[88] = 0.246649314068722127684793274205361333774844721642932483825112e1;
	r[89] = 0.237985857405291309841019009567664344433227438437814545978265e1;
	r[90] = 0.220732860223603125324501063863431239360964598494895804636385e1;
	r[91] = 0.195366505465078280021011318969670413005631115825503067859224e1;
	r[92] = 0.162639526192302042654152719941615819296640321425903814243421e1;
	r[93] = 0.12355409635477177243720420601286748822407912685173893839954e1;
	r[94] = 0.793270483842601765901660451298724430404145573157076476093404e0;
	r[95] = 0.313487466967411737619705722173152314788433913684534996948575e0;
	r[96] = -0.188629036887495385702289524602477385497317354178837866977558e0;
	r[97] = -0.697117369158007187153671599420999383363929895815187374146979e0;
	r[98] = -0.119574273480976888634306726694693857268463381641155346714848e1;
	r[99] = -0.166850720660225523707822126933168193239337049815675767885134e1;
	r[100] = -0.210014466980486256363682541169164912605159729681460335084457e1;
#endif
}

static void const_series_c (double re_q, double im_q, double *prep, double *pimp)
{
	int i;
	double tmp;
	*prep = 0.0;
	*pimp = 0.0;

	double rep = 0.0;
	double imp = 0.0;

#if 0
	double a[8];
	a[0] = -0.077215664901532851;
	a[1] = -0.0047486314774196408;
	a[2] = 0.00036610089349548089;
	a[3] = 0.00037600730566372326;
	a[4] = 0.00014301182486231440;
	a[5] = 3.3997818936021684e-5;
	a[6] = -4.8324221220657863e-7;
	a[7] = -6.7778497812918602e-6;
#endif

	double re_zn = 1.0;
	double im_zn = 0.0;

	for (i=0; i<100; i++)
	{
		// a[i] += 0.5 / ((double) (i+1));
		// rep += a[i] * re_zn;
		// imp += a[i] * im_zn;
		
		double a = r[i] * exp (-4.0*sqrt(i+1));
		rep += a * re_zn;
		imp += a * im_zn;
		
		tmp = re_q * re_zn - im_q * im_zn;
		im_zn = re_q * im_zn + im_q * re_zn;
		re_zn = tmp;
	}
	
	*prep = rep;
	*pimp = imp;
}
			  
static void alpha_series_c (double re_q, double im_q, double *prep, double *pimp)
{
	double tmp;
	*prep = 0.0;
	*pimp = 0.0;

	double rep = 0.0;
	double imp = 0.0;

// printf ("z=%g + i %g\n", re_q, im_q);
	/*  1-z */
	double re_one_minus_z = 1.0 - re_q;
	double im_one_minus_z = - im_q;

	/* 1/(1-z) */
	tmp = re_one_minus_z*re_one_minus_z + im_one_minus_z*im_one_minus_z;
	tmp = 1.0/tmp;
	double re_one_over_one_minus_z = re_one_minus_z * tmp;
	double im_one_over_one_minus_z = -im_one_minus_z * tmp;

// printf ("1/(1-z)=%g + i %g\n", re_one_over_one_minus_z, im_one_over_one_minus_z);
	/* 1/z */
	tmp = 1.0/(re_q*re_q + im_q * im_q);
	double re_one_over_z = re_q * tmp;
	double im_one_over_z = -im_q * tmp;
// printf (" 1/z=%g + i %g\n", re_one_over_z, im_one_over_z);
			  
	/* ln gamma (1/(1-z)) */
	gsl_sf_result mod_lng, arg_lng;
	gsl_sf_lngamma_complex_e (re_one_over_one_minus_z, im_one_over_one_minus_z, 
	                &mod_lng, &arg_lng);

	double re_lng = mod_lng.val;
	double im_lng = arg_lng.val;
// printf ("ln gamma 1/(1-z)=%g + i %g\n", re_lng, im_lng);

	/* (1/z) * ln gamma (1/(1-z)) */
	rep += re_one_over_z * re_lng - im_one_over_z * im_lng;
	imp += re_one_over_z * im_lng + im_one_over_z * re_lng;

// printf ("first gamma term =%g + i %g\n", rep, imp);
	/* log (1-z) */
	gsl_sf_result m_lnz, t_lnz;
	gsl_sf_complex_log_e (re_one_minus_z, im_one_minus_z, &m_lnz, &t_lnz);
	double re_ln_omz = m_lnz.val;
	double im_ln_omz = t_lnz.val;
// printf ("ln (1-z)=%g + i %g\n", re_ln_omz, im_ln_omz);
	
	/* (1/z) * (1/(1-z)) */
	double re_zz = re_one_over_z * re_one_over_one_minus_z - im_one_over_z * im_one_over_one_minus_z;
	double im_zz = re_one_over_z * im_one_over_one_minus_z + im_one_over_z * re_one_over_one_minus_z;

	/* (1+z) / (z(1-z)) */
	double re_tz = (1.0+re_q) * re_zz - im_q * im_zz;
	double im_tz = (1.0+re_q) * im_zz + im_q * re_zz;

	/* add 0.5 * log (1-z) * (1+z)/(z(1-z)) */
	rep += 0.5 * (re_ln_omz * re_tz - im_ln_omz * im_tz);
	imp += 0.5 * (re_ln_omz * im_tz + im_ln_omz * re_tz);
// printf ("log term =%g + i %g\n", rep, imp);
	
	/* add 1/(1-z) */
	rep += re_one_over_one_minus_z;
	imp += im_one_over_one_minus_z;
	
// printf ("tot=%g + i %g\n", rep, imp);

// printf ("\n");
	*prep = rep;
	*pimp = imp;
}

static double alpha_series (double re_q, double im_q)
{
	double rep, imp;
	
#define AT_INFINITY
#ifdef AT_INFINITY
	double tmp = 1.0 / (re_q *re_q + im_q * im_q);
	double reo = re_q * tmp;
	double imo = -im_q * tmp;
	re_q = reo;
	im_q = imo;
#endif
	
	alpha_series_c (re_q, im_q, &rep, &imp);

	// const_series_c (re_q, im_q, &rep, &imp);
	
#if 0
	double reo = rep * re_q - imp * im_q;
	double imo = rep * im_q + imp * re_q;

	rep = reo;
	imp = imo;
#endif

	// return sqrt (rep*rep+imp*imp);
	// return log (sqrt (rep*rep+imp*imp));
	return rep;
	// return (atan2 (imp, rep) + M_PI) / (2.0*M_PI);
}

/*-------------------------------------------------------------------*/
/* This routine fills in the interior of the the convergent area of the 
 * Euler alpha in a simple way 
 */


void 
MakeHisto (
   float  	*glob,
   int 		sizex,
   int 		sizey,
   double	re_center,
   double	im_center,
   double	width,
   double	height,
   int		itermax,
   double 	renorm)
{
   int		i,j, globlen;
   double	re_start, im_start, delta;
   double	re_position, im_position;
   
   delta = width / (double) sizex;
   re_start = re_center - width / 2.0;
   im_start = im_center + width * ((double) sizey) / (2.0 * (double) sizex);
   
   globlen = sizex*sizey;
   for (i=0; i<globlen; i++) glob [i] = 0.0;

	init_r();

   im_position = im_start;
   for (i=0; i<sizey; i++) 
	{
      if (i%10==0) printf(" start row %d\n", i);
      re_position = re_start;
      for (j=0; j<sizex; j++) 
		{

			double phi = alpha_series (re_position, im_position);
         glob [i*sizex +j] = phi;

         re_position += delta;
      }
      im_position -= delta;  /*top to bottom, not bottom to top */
   }
}

/* --------------------------- END OF LIFE ------------------------- */
